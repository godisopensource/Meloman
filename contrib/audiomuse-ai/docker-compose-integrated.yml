# AudioMuse-AI + Navidrome Integrated Docker Compose
# Deploys both Navidrome and AudioMuse-AI together in the same network

services:
  # ============================================
  # NAVIDROME - Music Server
  # ============================================
  navidrome:
    image: deluan/navidrome:latest
    container_name: navidrome
    ports:
      - "4533:4533"
    environment:
      ND_SCANSCHEDULE: "1h"
      ND_LOGLEVEL: "info"
      ND_SESSIONTIMEOUT: "24h"
      ND_ENABLETRANSCODINGCONFIG: "true"
    volumes:
      - navidrome-data:/data
      - ${MUSIC_FOLDER:-/path/to/music}:/music:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4533/ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # AUDIOMUSE-AI - Music Recommendation Engine
  # ============================================
  
  # Redis for task queue
  audiomuse-redis:
    image: redis:7-alpine
    container_name: audiomuse-redis
    volumes:
      - audiomuse-redis-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL database
  audiomuse-postgres:
    image: postgres:15-alpine
    container_name: audiomuse-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-audiomuse}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-audiomusepassword}
      POSTGRES_DB: ${POSTGRES_DB:-audiomusedb}
    volumes:
      - audiomuse-postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-audiomuse}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # AudioMuse-AI Flask web application
  audiomuse-ai-flask:
    image: ghcr.io/neptunehub/audiomuse-ai:latest
    container_name: audiomuse-ai-flask
    ports:
      - "8000:8000"
    environment:
      SERVICE_TYPE: "flask"
      MEDIASERVER_TYPE: "navidrome"
      # Connect to navidrome container directly
      NAVIDROME_URL: "http://navidrome:4533"
      NAVIDROME_USER: "${NAVIDROME_USER}"
      NAVIDROME_PASSWORD: "${NAVIDROME_PASSWORD}"
      POSTGRES_USER: ${POSTGRES_USER:-audiomuse}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-audiomusepassword}
      POSTGRES_DB: ${POSTGRES_DB:-audiomusedb}
      POSTGRES_HOST: "audiomuse-postgres"
      POSTGRES_PORT: "5432"
      REDIS_URL: "redis://audiomuse-redis:6379/0"
      AI_MODEL_PROVIDER: "${AI_MODEL_PROVIDER:-NONE}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      OPENAI_SERVER_URL: "${OPENAI_SERVER_URL:-}"
      OPENAI_MODEL_NAME: "${OPENAI_MODEL_NAME:-}"
      GEMINI_API_KEY: "${GEMINI_API_KEY:-}"
      MISTRAL_API_KEY: "${MISTRAL_API_KEY:-}"
      TEMP_DIR: "/app/temp_audio"
    volumes:
      - audiomuse-temp-flask:/app/temp_audio
    depends_on:
      navidrome:
        condition: service_healthy
      audiomuse-redis:
        condition: service_healthy
      audiomuse-postgres:
        condition: service_healthy
    restart: unless-stopped

  # AudioMuse-AI Worker for background processing
  audiomuse-ai-worker:
    image: ghcr.io/neptunehub/audiomuse-ai:latest
    container_name: audiomuse-ai-worker
    environment:
      SERVICE_TYPE: "worker"
      MEDIASERVER_TYPE: "navidrome"
      NAVIDROME_URL: "http://navidrome:4533"
      NAVIDROME_USER: "${NAVIDROME_USER}"
      NAVIDROME_PASSWORD: "${NAVIDROME_PASSWORD}"
      POSTGRES_USER: ${POSTGRES_USER:-audiomuse}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-audiomusepassword}
      POSTGRES_DB: ${POSTGRES_DB:-audiomusedb}
      POSTGRES_HOST: "audiomuse-postgres"
      POSTGRES_PORT: "5432"
      REDIS_URL: "redis://audiomuse-redis:6379/0"
      AI_MODEL_PROVIDER: "${AI_MODEL_PROVIDER:-NONE}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      OPENAI_SERVER_URL: "${OPENAI_SERVER_URL:-}"
      OPENAI_MODEL_NAME: "${OPENAI_MODEL_NAME:-}"
      GEMINI_API_KEY: "${GEMINI_API_KEY:-}"
      MISTRAL_API_KEY: "${MISTRAL_API_KEY:-}"
      TEMP_DIR: "/app/temp_audio"
    volumes:
      - audiomuse-temp-worker:/app/temp_audio
    depends_on:
      navidrome:
        condition: service_healthy
      audiomuse-redis:
        condition: service_healthy
      audiomuse-postgres:
        condition: service_healthy
    restart: unless-stopped

volumes:
  navidrome-data:
  audiomuse-redis-data:
  audiomuse-postgres-data:
  audiomuse-temp-flask:
  audiomuse-temp-worker:
